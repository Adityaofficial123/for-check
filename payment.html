<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Payment - CampusMart</title>

  <!-- âœ… Custom CSS -->
  <link rel="stylesheet" href="style2.css" />

  <!-- âœ… Font Awesome (no integrity issue) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" />

  <!-- âœ… Google Fonts (Poppins) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
</head>


<body>
<!-- ğŸŒŸ Review Modal -->
<div id="reviewPopup" class="review-popup">
  <div class="review-content">
    <span class="close-review" onclick="closeReviewPopup()">&times;</span>
    <h2>Share Your Experience ğŸ“¢</h2>
    <textarea id="userReview" placeholder="Write your feedback here..."></textarea>

    <!-- â­ Star Rating -->
    <div id="starRating" class="star-rating">
      <span class="star" data-value="1">â˜…</span>
      <span class="star" data-value="2">â˜…</span>
      <span class="star" data-value="3">â˜…</span>
      <span class="star" data-value="4">â˜…</span>
      <span class="star" data-value="5">â˜…</span>
    </div>

    <button onclick="submitReview()" class="submit-review-btn">Submit Review</button>
  </div>
</div>

<div class="payment-container">
  <div class="product-details">
    <div class="product-image" id="productImage"></div>
    <div class="product-info">
      <h2 id="productName">Product Name</h2>
      <p id="productDescription">Product description...</p>
      <p><strong>Category:</strong> <span id="productCategory"></span></p>
      <p><strong>Price:</strong> â‚¹<span id="productPrice"></span></p>
      <div class="payment-section">
        <button class="pay-btn-modern" onclick="showPaymentPopup()">
          <i class="fas fa-wallet"></i> Proceed to Payment
        </button>
        <!-- UPI Button -->
<a id="upiPayButton" href="#" class="pay-btn-modern mobile-only">
  <i class="fas fa-wallet"></i> Pay via UPI App
</a>           
      </div>
    </div>
  <div class="upi-proof-box glassy-box">
  <h3>ğŸ’¸ Submit UPI Payment Proof</h3>
  <p class="instructions">
    After completing your payment, please enter your <strong>UPI Reference ID</strong> and upload the <strong>payment screenshot</strong> as proof.
  </p>

  <input type="text" id="manualPaymentId" placeholder="Enter your UPI Reference ID" class="glass-input" />

  <input type="file" id="paymentProofScreenshot" accept="image/*" class="glass-file" />

  <button onclick="submitUPIPayment()" class="glass-button">
    <i class="fas fa-paper-plane"></i> Submit Payment
  </button>
</div>

  </div>
  
  <a href="index.html" class="back-btn">â† Back to Home</a>
  <div id="contactNoteBox" style="display:none; margin-top: 20px; padding: 15px; background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 5px;">
    <strong>Note:</strong> if any quries please contact on this number <strong>8766880183</strong>.
  </div>
</div>
<section class="attention-guide">
  <h2><span class="icon">ğŸ”°</span> Smooth & Safe Buying Process</h2>

  <div class="attention-cards">
    <div class="attention-card">
      <span class="attention-icon">ğŸ›’</span>
      <h3>1. Browse & Select</h3>
      <p>Look through the available products and pick your favorite.</p>
    </div>

    <div class="attention-card">
      <span class="attention-icon">ğŸ’³</span>
      <h3>2. Payment & UPI Reference</h3>
      <p>Click <strong>Proceed to Payment</strong> and <span class="highlight">send your UPI Reference ID</span> <strong>(compulsory)</strong>.</p>
    </div>

    <div class="attention-card">
      <span class="attention-icon">âœ…</span>
      <h3>3. Confirmation & Email</h3>
      <p>Youâ€™ll get a <strong>confirmation email</strong> with product details and next steps.</p>
    </div>

    <div class="attention-card highlight-card">
      <span class="attention-icon">ğŸ›¡ï¸</span>
      <h3>4. 100% Money Safety</h3>
      <p>Your money is <strong>100% safe</strong>. If you donâ€™t like the product after seeing it, <strong>you get a refund (minus 2% platform fee)</strong>.</p>
    </div>

    <div class="attention-card">
      <span class="attention-icon">ğŸ””</span>
      <h3>5. Stay Updated</h3>
      <p>Always <strong>check your email</strong> for updates on delivery & next steps.</p>
    </div>

    <div class="attention-card">
      <span class="attention-icon">ğŸ’¬</span>
      <h3>6. Bargain & Inform</h3>
      <p>If you bargain, <strong>inform us immediately</strong> by phone or message for smooth processing.</p>
    </div>

    <div class="attention-card">
      <span class="attention-icon">ğŸ“¦</span>
      <h3>7. Check Your Cart & Confirm</h3>
      <p>After payment, <strong>click the cart icon ğŸ›’</strong> at the top right to see your product. Once you receive it, please <strong>click the "Confirm Product Received" button</strong> in the cart to complete the process.</p>
    </div>
  </div>
</section>
<!-- Email -->
<script type="module">


  import emailjs from 'https://esm.sh/@emailjs/browser';


emailjs.init("wVTxCgXP-mcJn5IP4");
  window.sendBuyerEmail = function(data) {
    console.log("ğŸ“¨ Sending buyer email with:", data);
    emailjs.send("service_e32z7z5", "template_bd14k2m", {
      buyer_name: data.buyer_name,
      email: data.email,
      product_name: data.productName,
      price: data.amount,
      order_date: new Date().toLocaleString(),
      seller_name: "CampusMart Seller"
    }).then(
      (response) => console.log("âœ… Buyer email sent!", response),
      (error) => console.error("âŒ Buyer email failed:", error)
    );
  };
</script>


<!-- QR Code Popup -->
<div id="qrPopup" class="qr-popup-modern glass-popup">
  <div class="qr-content-modern light-glass">
    <span class="close-btn-modern" onclick="closePaymentPopup()">&times;</span>
    <h2 class="popup-heading">Scan & Pay</h2>
    <img src="payment.jpg" alt="QR Code" class="qr-img-modern" />
    <p class="upi-id-modern">UPI ID: <strong>dipaktaywade3@okaxis</strong></p>
    <h3 class="popup-subheading">After Payment, Submit Proof</h3>
   <input type="text" id="popupPaymentId" placeholder="Enter UPI Reference ID" class="glass-input" />
   <input type="file" id="popupPaymentScreenshot" accept="image/*" class="glass-file" />
   <button onclick="sendPaymentId()" class="glass-button send-id-btn">

      <i class="fas fa-paper-plane"></i> Submit Payment
    </button>
  </div>
</div>


<!-- Success Animation Popup -->
<div id="successPopup" class="success-popup">
  <!-- <button id="adminConfirmBtn" style="display:none;" onclick="adminConfirmPayment()">âœ… Confirm Payment</button> -->
  <div class="checkmark-wrapper">
    <svg class="checkmark" viewBox="0 0 52 52">
      <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" />
      <path class="checkmark-check" fill="none" d="M14 27l7 7 16-16" />
    </svg>
    <p class="success-message">Payment Successful!</p>
  </div>
</div>
<!-- âœ… Local Audio File (instead of blocked pixabay link) -->
<audio id="successSound" src="assets/audio/success.mp3" preload="auto"></audio>

<!-- ğŸ‰ Confetti Effect -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
  function handlePaymentSuccess() {
    const sound = document.getElementById("successSound");

    // âœ… Play success sound
    if (sound) {
      sound.muted = false;
      sound.volume = 1.0;
      sound.play().catch(err => {
        console.warn("ğŸ”‡ Autoplay blocked. Will retry on user interaction.");
      });
    }
function handlePaymentSuccess() {
  document.getElementById("successPopup").style.display = "flex";
  handlePaymentSuccess();
}

    // ğŸ‰ Launch confetti
    confetti({
      particleCount: 150,
      spread: 70,
      origin: { y: 0.6 }
    });

    // âœ… Show alert popup after short delay
    setTimeout(() => {
      alert("ğŸ‰ Payment Successful!");
    }, 500);
  }

  // ğŸŸ¢ Example usage: Call this function after successful payment
  // handlePaymentSuccess();
</script>


<!-- Firebase & Logic -->
<script type="module">
  

    import { firebaseConfig } from './firebase-config.js';
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
  
  import {
    getDatabase, ref, push, set
  } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
  import {
    getAuth, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
  


  const cloudinaryUpload = async (file) => {
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", "your_upload_preset");  // replace with your Cloudinary preset
  const response = await fetch("https://api.cloudinary.com/v1_1/dobzp321s/image/upload", {
    method: "POST",
    body: formData
  });
  const data = await response.json();
  return data.secure_url;
};

  const app = initializeApp(firebaseConfig);
 

  const db = getDatabase(app);
  const auth = getAuth(app);
  let selectedRating = 0;

// Show review popup after successful payment
function showReviewPopup() {
  document.getElementById("reviewPopup").style.display = "flex";
}

// Close popup
window.closeReviewPopup = () => {
  document.getElementById("reviewPopup").style.display = "none";
};



// Submit review
window.submitReview = async () => {
  const reviewText = document.getElementById("userReview").value.trim();
  if (!reviewText || selectedRating === 0) {
    return alert("Please write a review and select a rating.");
  }

  const user = auth.currentUser;
  if (!user) return alert("Login required to submit review.");

  const reviewData = {
    uid: user.uid,
    name: user.displayName || "Anonymous",
    email: user.email,
    message: reviewText,
    rating: selectedRating,
    timestamp: new Date().toISOString()
  };

  try {
    await push(ref(db, "reviews"), reviewData);
    alert("âœ… Thanks for your feedback!");
    closeReviewPopup();
  } catch (err) {
    console.error("âŒ Review failed", err);
    alert("Something went wrong. Try again.");
  }
};

// Star selection logic
document.addEventListener("DOMContentLoaded", () => {
  const stars = document.querySelectorAll(".star");
  stars.forEach(star => {
    star.addEventListener("click", () => {
      selectedRating = parseInt(star.getAttribute("data-value"));
      stars.forEach(s => s.classList.remove("selected"));
      for (let i = 0; i < selectedRating; i++) {
        stars[i].classList.add("selected");
      }
    });
  });
});


// âœ… Show payment modal
window.showPaymentPopup = () => {
  document.getElementById("qrPopup").style.display = "flex";
};

// âœ… Close modal
window.closePaymentPopup = () => {
  document.getElementById("qrPopup").style.display = "none";
};

// âœ… Send UPI Payment ID & Screenshot to Firebase
window.sendPaymentId = async function () {
  
 const enteredId = document.getElementById("popupPaymentId").value.trim();
const screenshotInput = document.getElementById("popupPaymentScreenshot"); // ğŸ” updated ID
const screenshotFile = screenshotInput.files[0];

  const sendButton = document.querySelector(".send-id-btn");

if (!enteredId || !screenshotFile || !screenshotFile.type.startsWith("image/")) {
  alert("âŒ Please enter UPI Reference ID and upload a valid payment screenshot.");
  return;
}


  const user = auth.currentUser;
  if (!user) {
    alert("You must be logged in to make a payment.");
    return;
  }

  const product = JSON.parse(localStorage.getItem("selectedProduct"));
  if (!product) {
    alert("âŒ No product found in localStorage.");
    return;
  }

  const customPayId = 'pay_' + Date.now();

  // âœ… Upload screenshot to Firebase Storage

const downloadURL = await cloudinaryUpload(screenshotFile);

  
  try {
    sendButton.disabled = true;
    sendButton.textContent = "Uploading Proof...";



    const paymentData = {
      userId: user.uid,
      email: user.email || "",
      payId: enteredId,
      name: user.displayName || "anonymous",
      buyer_name: user.displayName || "anonymous",
      buyer_email: user.email || "",
      amount: product.price || "",
      productId: product.id || "",
      productName: product.product_name || "",
      proofUrl: downloadURL,
      timestamp: new Date().toISOString()
    };

    console.log("ğŸ”¥ Submitting payment data:", paymentData);

    await set(ref(db, 'payments/' + customPayId), paymentData);
    sendBuyerEmail(paymentData);
    handlePaymentSuccess();

  await fetch('https://script.google.com/macros/s/AKfycbz-ojRLbqkCUFrFK0qe9bJOMHPZnTYuf_djXUlrzRy7Y1dsitmB0HMItgbIBfkS3LGd/exec', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(paymentData)
});


    // âœ… Show success
    document.querySelector(".pay-btn-modern").style.display = "none";
    const paymentSection = document.querySelector(".payment-section");
    const successMessage = document.createElement("p");
    successMessage.textContent = "âœ… Payment Successfully Done!";
    successMessage.style.color = "green";
    successMessage.style.fontWeight = "bold";
    paymentSection.appendChild(successMessage);
handlePaymentSuccess();


  } catch (err) {
    console.error("âŒ Error:", err);
    alert("âŒ Payment failed. Try again.");
  } finally {
    sendButton.disabled = false;
    sendButton.textContent = "Send My Payment ID";
  }
};

document.getElementById("popupPaymentId").addEventListener("input", toggleButton);
document.getElementById("popupPaymentScreenshot").addEventListener("change", toggleButton);


function toggleButton() {
  const id = document.getElementById("popupPaymentId").value.trim();
 const file = document.getElementById("popupPaymentScreenshot").files[0];

  document.querySelector(".send-id-btn").disabled = !(id && file);
}

    // â›” No redirect
    // setTimeout(() => {
    //   window.location.href = "index.html";
    // }, 3000);
  

  // Load selected product
  window.onload = () => {
    const product = JSON.parse(localStorage.getItem('selectedProduct'));
    if (product) {
      document.getElementById('productName').textContent = product.product_name;
      document.getElementById('productDescription').textContent = product.description;
      document.getElementById('productCategory').textContent = product.category;
      document.getElementById('productPrice').textContent = product.price;
      document.getElementById('productImage').style.backgroundImage = `url(${product.image_url})`;
    } else {
      document.querySelector('.payment-container').innerHTML = '<p style="text-align:center">No product selected.</p>';
    }
  };


  window.addEventListener("DOMContentLoaded", () => {
    const product = JSON.parse(localStorage.getItem("selectedProduct"));
    if (!product) {
      alert("No product found. Redirecting...");
      window.location.href = "index.html";
      return;
    }

    // Set product details
    document.getElementById("productName").textContent = product.product_name;
    document.getElementById("productDescription").textContent = product.description;
    document.getElementById("productCategory").textContent = product.category;
    document.getElementById("productPrice").textContent = product.price;
    document.getElementById("productImage").style.backgroundImage = `url(${product.image_url})`;

    // Handle UPI button click
    const upiButton = document.getElementById("upiPayButton");
    upiButton.addEventListener("click", () => {
      const upiLink = `upi://pay?pa=dipaktaywade3@okaxis&pn=CampusMart&am=${product.price}&cu=INR`;
      // âœ… Use window.location.href to trigger deep link
      window.location.href = upiLink;
    });
  });
</script>

<script>
  fetch("footer.html")
    .then(res => res.text())
    .then(data => {
      document.getElementById("footer-container").innerHTML = data;
      
    });
</script>
<div id="footer-container"></div>
</body>
</html>
